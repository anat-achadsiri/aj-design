<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Screen Designer - UI Spec Tool</title>
    <!-- KeenIcons CSS from local assets -->
    <link rel="stylesheet" href="assets/plugins/global/plugins.bundle.css">
    <style>
        /* Theme Variables */
        :root {
            /* Default Theme */
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --button-bg: #f8fafc;
            --button-primary-bg: #0ea5e9;
            --button-success-bg: #22c55e;
            --button-danger-bg: #ef4444;
            --table-header-bg: #e0f2fe;
            --table-header-border: #7dd3fc;
            --table-header-color: #0369a1;
            --tab-active-bg: #e0f2fe;
            --tab-active-color: #0369a1;
            --tab-active-border: #7dd3fc;
            --input-border: #cbd5e1;
            --panel-header-bg: #f1f5f9;
            --label-color: #1e293b;
        }

        /* AJ Theme - Based on Spec screenshots */
        [data-theme="aj"] {
            --primary-color: #0891b2;
            --primary-hover: #0e7490;
            --button-bg: #f0fdfa;
            --button-primary-bg: #14b8a6;
            --button-success-bg: #10b981;
            --button-danger-bg: #f43f5e;
            --table-header-bg: #ccfbf1;
            --table-header-border: #5eead4;
            --table-header-color: #0f766e;
            --tab-active-bg: #ccfbf1;
            --tab-active-color: #0f766e;
            --tab-active-border: #5eead4;
            --input-border: #99f6e4;
            --panel-header-bg: #f0fdfa;
            --label-color: #134e4a;
        }

        /* Blue Theme */
        [data-theme="blue"] {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --button-bg: #eff6ff;
            --button-primary-bg: #3b82f6;
            --button-success-bg: #22c55e;
            --button-danger-bg: #ef4444;
            --table-header-bg: #dbeafe;
            --table-header-border: #93c5fd;
            --table-header-color: #1e40af;
            --tab-active-bg: #dbeafe;
            --tab-active-color: #1e40af;
            --tab-active-border: #93c5fd;
            --input-border: #93c5fd;
            --panel-header-bg: #eff6ff;
            --label-color: #1e3a8a;
        }

        /* Purple Theme */
        [data-theme="purple"] {
            --primary-color: #7c3aed;
            --primary-hover: #6d28d9;
            --button-bg: #f5f3ff;
            --button-primary-bg: #8b5cf6;
            --button-success-bg: #22c55e;
            --button-danger-bg: #ef4444;
            --table-header-bg: #ede9fe;
            --table-header-border: #c4b5fd;
            --table-header-color: #5b21b6;
            --tab-active-bg: #ede9fe;
            --tab-active-color: #5b21b6;
            --tab-active-border: #c4b5fd;
            --input-border: #c4b5fd;
            --panel-header-bg: #f5f3ff;
            --label-color: #4c1d95;
        }

        /* Gray Theme */
        [data-theme="gray"] {
            --primary-color: #475569;
            --primary-hover: #334155;
            --button-bg: #f8fafc;
            --button-primary-bg: #64748b;
            --button-success-bg: #22c55e;
            --button-danger-bg: #ef4444;
            --table-header-bg: #f1f5f9;
            --table-header-border: #cbd5e1;
            --table-header-color: #334155;
            --tab-active-bg: #e2e8f0;
            --tab-active-color: #334155;
            --tab-active-border: #94a3b8;
            --input-border: #cbd5e1;
            --panel-header-bg: #f1f5f9;
            --label-color: #1e293b;
        }

        /* Metronic Theme - KeenThemes Style */
        [data-theme="metronic"] {
            --primary-color: #1b84ff;
            --primary-hover: #056ee9;
            --button-bg: #f9f9f9;
            --button-primary-bg: #1b84ff;
            --button-success-bg: #17c653;
            --button-danger-bg: #f8285a;
            --button-warning-bg: #f6b100;
            --table-header-bg: #f9f9f9;
            --table-header-border: #e9e9e9;
            --table-header-color: #252f4a;
            --tab-active-bg: #1b84ff;
            --tab-active-color: #ffffff;
            --tab-active-border: #1b84ff;
            --input-border: #dbdfe9;
            --panel-header-bg: #f9f9f9;
            --label-color: #252f4a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar - Component Palette */
        .sidebar {
            width: 240px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }

        .sidebar-header h2 {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .component-group {
            padding: 12px;
            border-bottom: 1px solid #334155;
        }

        .component-group h3 {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .component-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: #334155;
            border-radius: 6px;
            cursor: grab;
            transition: all 0.2s;
            font-size: 13px;
        }

        .component-item:hover {
            background: #475569;
            transform: translateX(4px);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-item .icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Main Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            gap: 8px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 8px;
            border-right: 1px solid #e2e8f0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #475569;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .toolbar-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .toolbar-btn.primary:hover {
            background: #2563eb;
        }

        .toolbar-btn.danger {
            color: #dc2626;
            border-color: #fecaca;
        }

        .toolbar-btn.danger:hover {
            background: #fef2f2;
        }

        .screen-name-input {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }

        .screen-name-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            overflow: auto;
            padding: 24px;
            background: #e2e8f0;
        }

        .canvas {
            background: white;
            min-width: 400px;
            min-height: 300px;
            position: relative;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding-bottom: 50px;
            padding-right: 50px;
        }

        /* Canvas Resize Handles */
        .canvas-resize-handle {
            position: absolute;
            background: #3b82f6;
            border-radius: 2px;
            z-index: 100;
        }

        .canvas-resize-handle.right {
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 40px;
            cursor: e-resize;
        }

        .canvas-resize-handle.bottom {
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 8px;
            cursor: s-resize;
        }

        .canvas-resize-handle.corner {
            right: -6px;
            bottom: -6px;
            width: 12px;
            height: 12px;
            cursor: se-resize;
            border-radius: 3px;
        }

        .canvas.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        /* Marquee Selection */
        .marquee-selection {
            position: absolute;
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        /* Multi-selected components */
        .dropped-component.multi-selected {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
        }

        /* Dropped Components */
        .dropped-component {
            position: absolute;
            cursor: move;
            min-width: 50px;
            min-height: 30px;
        }

        .dropped-component.selected {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .dropped-component:hover {
            outline: 2px solid #93c5fd;
            outline-offset: 2px;
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border: 1px solid white;
            border-radius: 2px;
        }

        .resize-handle.se { right: -4px; bottom: -4px; cursor: se-resize; }
        .resize-handle.sw { left: -4px; bottom: -4px; cursor: sw-resize; }
        .resize-handle.ne { right: -4px; top: -4px; cursor: ne-resize; }
        .resize-handle.nw { left: -4px; top: -4px; cursor: nw-resize; }
        .resize-handle.e { right: -4px; top: 50%; transform: translateY(-50%); cursor: e-resize; }
        .resize-handle.w { left: -4px; top: 50%; transform: translateY(-50%); cursor: w-resize; }
        .resize-handle.n { top: -4px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -4px; left: 50%; transform: translateX(-50%); cursor: s-resize; }

        /* Component Styles - Using Theme Variables */
        .comp-label {
            display: block;
            width: 100%;
            height: 100%;
            font-size: 14px;
            color: var(--label-color);
            padding: 4px;
            box-sizing: border-box;
            line-height: 1.4;
            overflow: hidden;
            cursor: text;
            outline: none;
        }

        .comp-label:focus {
            background: #fefce8;
            border: 1px dashed #facc15;
            border-radius: 2px;
        }

        .comp-textbox {
            width: 100%;
            height: 100%;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
        }

        .comp-textarea {
            width: 100%;
            height: 100%;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 14px;
            background: white;
            resize: none;
            box-sizing: border-box;
        }

        .comp-datepicker {
            display: flex;
            align-items: center;
            width: 100%;
            height: 100%;
            gap: 8px;
        }

        .comp-datepicker input {
            flex: 1;
            height: 100%;
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .comp-datepicker .calendar-icon {
            width: 32px;
            height: 100%;
            min-height: 32px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--button-bg);
            cursor: pointer;
        }

        .comp-dropdown {
            width: 100%;
            height: 100%;
            padding: 0 32px 0 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            box-sizing: border-box;
        }

        .comp-dropdown-wrapper {
            position: relative;
            display: block;
            width: 100%;
            height: 100%;
        }

        .comp-dropdown-wrapper::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid #475569;
            pointer-events: none;
        }

        .comp-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            color: var(--label-color);
        }

        .comp-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .comp-radio {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
            color: var(--label-color);
        }

        .comp-radio input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .comp-button {
            width: 100%;
            height: 100%;
            padding: 8px 20px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: var(--button-bg);
            box-sizing: border-box;
        }

        .comp-button.primary {
            background: var(--button-primary-bg);
            color: white;
            border-color: var(--button-primary-bg);
        }

        .comp-button.success {
            background: var(--button-success-bg);
            color: white;
            border-color: var(--button-success-bg);
        }

        .comp-button.danger {
            background: var(--button-danger-bg);
            color: white;
            border-color: var(--button-danger-bg);
        }

        .comp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .comp-table th {
            background: var(--table-header-bg);
            border: 1px solid var(--table-header-border);
            padding: 8px 12px;
            font-weight: 600;
            color: var(--table-header-color);
        }

        .comp-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            background: white;
        }

        .comp-tabs {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .comp-tabs .tab-header {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .comp-tabs .tab-item {
            padding: 10px 20px;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            background: #f8fafc;
            cursor: pointer;
            font-size: 14px;
            margin-right: -1px;
        }

        .comp-tabs .tab-item.active {
            background: var(--tab-active-bg);
            color: var(--tab-active-color);
            border-color: var(--tab-active-border);
            font-weight: 600;
        }

        .comp-tabs .tab-content {
            border: 1px solid #e2e8f0;
            border-top: none;
            padding: 16px;
            flex: 1;
            background: white;
            box-sizing: border-box;
        }

        .comp-panel {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            box-sizing: border-box;
        }

        .comp-panel .panel-header {
            padding: 12px 16px;
            background: var(--panel-header-bg);
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 14px;
            color: var(--label-color);
        }

        .comp-panel .panel-body {
            padding: 16px;
            flex: 1;
        }

        .comp-title {
            display: block;
            width: 100%;
            height: 100%;
            font-size: 18px;
            font-weight: 600;
            color: var(--label-color);
            padding: 8px 4px;
            box-sizing: border-box;
            cursor: text;
            outline: none;
        }

        .comp-title:focus {
            background: #fefce8;
            border: 1px dashed #facc15;
            border-radius: 2px;
        }

        .comp-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: #f8fafc;
        }

        .comp-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #cbd5e1;
            border-radius: 4px;
            background: #f8fafc;
            color: #94a3b8;
            cursor: pointer;
        }

        .comp-image-placeholder:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        /* Theme Selector Styles */
        .theme-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-selector label {
            font-size: 13px;
            color: #64748b;
        }

        .theme-selector select {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .theme-preview {
            display: flex;
            gap: 4px;
        }

        .canvas-size-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .canvas-size-controls label {
            font-size: 13px;
            color: #64748b;
        }

        .canvas-size-controls input[type="number"] {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
        }

        .canvas-size-controls span {
            color: #64748b;
            font-size: 13px;
        }

        .theme-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .comp-icon-btn {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            box-sizing: border-box;
        }

        .comp-icon-btn.edit { background: #dbeafe; color: #2563eb; }
        .comp-icon-btn.delete { background: #fee2e2; color: #dc2626; }
        .comp-icon-btn.view { background: #fef3c7; color: #d97706; }
        .comp-icon-btn.save { background: #d1fae5; color: #059669; }

        /* Annotation */
        .comp-annotation {
            position: relative;
        }

        .annotation-line {
            position: absolute;
            background: #3b82f6;
            height: 2px;
            transform-origin: left center;
        }

        .annotation-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid #3b82f6;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            position: absolute;
            right: -8px;
            top: -4px;
        }

        .annotation-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 12px;
            color: #92400e;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Properties Panel */
        .properties-panel {
            width: 280px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .properties-header {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }

        .properties-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .property-group {
            margin-bottom: 16px;
        }

        .property-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .property-group input,
        .property-group select,
        .property-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }

        .property-group input:focus,
        .property-group select:focus,
        .property-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .property-row {
            display: flex;
            gap: 8px;
        }

        .property-row .property-group {
            flex: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #64748b;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 160px;
            padding: 4px 0;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: #f1f5f9;
        }

        .context-menu-item.danger {
            color: #dc2626;
        }

        .context-menu-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 4px 0;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: #059669;
        }

        .toast.error {
            background: #dc2626;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar - Component Palette -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Components</h2>
            </div>

            <div class="component-group">
                <h3>Basic</h3>
                <div class="component-item" draggable="true" data-type="label">
                    <span class="icon">Aa</span>
                    <span>Label</span>
                </div>
                <div class="component-item" draggable="true" data-type="title">
                    <span class="icon">H</span>
                    <span>Title</span>
                </div>
                <div class="component-item" draggable="true" data-type="textbox">
                    <span class="icon">[ ]</span>
                    <span>TextBox</span>
                </div>
                <div class="component-item" draggable="true" data-type="textarea">
                    <span class="icon">[=]</span>
                    <span>TextArea</span>
                </div>
            </div>

            <div class="component-group">
                <h3>Input</h3>
                <div class="component-item" draggable="true" data-type="datepicker">
                    <span class="icon">üìÖ</span>
                    <span>DatePicker</span>
                </div>
                <div class="component-item" draggable="true" data-type="dropdown">
                    <span class="icon">‚ñº</span>
                    <span>Dropdown</span>
                </div>
                <div class="component-item" draggable="true" data-type="checkbox">
                    <span class="icon">‚òë</span>
                    <span>Checkbox</span>
                </div>
                <div class="component-item" draggable="true" data-type="radio">
                    <span class="icon">‚óâ</span>
                    <span>Radio</span>
                </div>
            </div>

            <div class="component-group">
                <h3>Actions</h3>
                <div class="component-item" draggable="true" data-type="button">
                    <span class="icon">‚ñ¢</span>
                    <span>Button</span>
                </div>
                <div class="component-item" draggable="true" data-type="iconbutton">
                    <span class="icon">‚óØ</span>
                    <span>Icon Button</span>
                </div>
            </div>

            <div class="component-group">
                <h3>Layout</h3>
                <div class="component-item" draggable="true" data-type="table">
                    <span class="icon">‚ñ¶</span>
                    <span>Table</span>
                </div>
                <div class="component-item" draggable="true" data-type="tabs">
                    <span class="icon">‚äû</span>
                    <span>Tabs</span>
                </div>
                <div class="component-item" draggable="true" data-type="panel">
                    <span class="icon">‚ñ≠</span>
                    <span>Panel</span>
                </div>
            </div>

            <div class="component-group">
                <h3>Annotation</h3>
                <div class="component-item" draggable="true" data-type="annotation">
                    <span class="icon">‚Üí</span>
                    <span>Arrow Note</span>
                </div>
                <div class="component-item" draggable="true" data-type="notebox">
                    <span class="icon">üìù</span>
                    <span>Note Box</span>
                </div>
            </div>

            <div class="component-group">
                <h3>Media</h3>
                <div class="component-item" draggable="true" data-type="image">
                    <span class="icon">üñºÔ∏è</span>
                    <span>Image</span>
                </div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="main-area">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-group">
                    <input type="text" class="screen-name-input" id="screenName" placeholder="Screen ID: sc-xxx" value="sc-pd001">
                    <input type="text" class="screen-name-input" id="screenTitle" placeholder="Screen Title" value="‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà">
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="saveDesign()">
                        üíæ Save JSON
                    </button>
                    <button class="toolbar-btn" onclick="loadDesign()">
                        üìÇ Load JSON
                    </button>
                    <button class="toolbar-btn" onclick="exportImage()">
                        üñºÔ∏è Export PNG
                    </button>
                    <button class="toolbar-btn primary" onclick="showImportImageModal()">
                        ü§ñ Import from Image
                    </button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="undo()">
                        ‚Ü© Undo
                    </button>
                    <button class="toolbar-btn" onclick="redo()">
                        ‚Ü™ Redo
                    </button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-btn danger" onclick="clearCanvas()">
                        üóëÔ∏è Clear All
                    </button>
                </div>
                <div class="toolbar-group theme-selector">
                    <label>Theme:</label>
                    <select id="themeSelect" onchange="changeTheme(this.value)">
                        <option value="default">Default</option>
                        <option value="aj">AJ Style (Teal)</option>
                        <option value="metronic">Metronic (KeenThemes)</option>
                        <option value="blue">Blue</option>
                        <option value="purple">Purple</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>
                <div class="toolbar-group canvas-size-controls">
                    <label>Canvas:</label>
                    <input type="number" id="canvasWidth" value="1200" min="800" step="100" style="width: 70px;" onchange="setCanvasSize()">
                    <span>x</span>
                    <input type="number" id="canvasHeight" value="800" min="600" step="100" style="width: 70px;" onchange="setCanvasSize()">
                    <button class="toolbar-btn" onclick="fitCanvasToComponents()" title="Fit to components">üìê Fit</button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="canvas-container">
                <div class="canvas" id="canvas">
                    <!-- Dropped components will appear here -->
                    <!-- Marquee Selection -->
                    <div class="marquee-selection" id="marqueeSelection"></div>
                    <!-- Canvas Resize Handles -->
                    <div class="canvas-resize-handle right" data-resize="e"></div>
                    <div class="canvas-resize-handle bottom" data-resize="s"></div>
                    <div class="canvas-resize-handle corner" data-resize="se"></div>
                </div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="properties-header">Properties</div>
            <div class="properties-content" id="propertiesContent">
                <p style="color: #94a3b8; font-size: 13px;">Select a component to edit its properties</p>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu hidden" id="contextMenu">
        <div class="context-menu-item" onclick="duplicateSelectedComponents()">
            üìã Duplicate (Ctrl+D)
        </div>
        <div class="context-menu-item" onclick="bringToFront()">
            ‚¨ÜÔ∏è Bring to Front
        </div>
        <div class="context-menu-item" onclick="sendToBack()">
            ‚¨áÔ∏è Send to Back
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="deleteSelectedComponents()">
            üóëÔ∏è Delete (Del)
        </div>
    </div>

    <!-- Hidden file input for loading JSON -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <!-- Hidden file input for AI image import -->
    <input type="file" id="imageInput" accept="image/*" style="display: none;">

    <!-- Hidden file input for component image -->
    <input type="file" id="componentImageInput" accept="image/*" style="display: none;">

    <!-- Import from Image Modal -->
    <div class="modal-overlay hidden" id="importImageModal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <span>ü§ñ Import UI from Image</span>
                <button class="modal-close" onclick="closeImportImageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="property-group">
                    <label>Anthropic API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." style="width: 100%;">
                    <small style="color: #64748b;">API Key ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô browser (localStorage)</small>
                </div>
                <div class="property-group" style="margin-top: 16px;">
                    <label>Select Image</label>
                    <div id="imageDropZone" style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; background: #f8fafc;">
                        <div id="imagePreviewContainer" style="display: none;">
                            <img id="imagePreview" style="max-width: 100%; max-height: 300px; border-radius: 4px;">
                            <p style="margin-top: 8px; color: #64748b; font-size: 13px;">Click to change image</p>
                        </div>
                        <div id="imagePlaceholder">
                            <span style="font-size: 48px;">üì∑</span>
                            <p style="color: #64748b; margin-top: 8px;">Click or drag image here</p>
                        </div>
                    </div>
                </div>
                <div id="importStatus" style="margin-top: 16px; display: none;">
                    <div style="display: flex; align-items: center; gap: 8px; color: #3b82f6;">
                        <span class="spinner"></span>
                        <span>Analyzing image with Claude AI...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="toolbar-btn" onclick="closeImportImageModal()">Cancel</button>
                <button class="toolbar-btn primary" onclick="analyzeImage()" id="analyzeBtn" disabled>ü§ñ Analyze & Import</button>
            </div>
        </div>
    </div>

    <style>
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        // State
        let components = [];
        let selectedComponent = null;
        let selectedComponents = []; // For multi-selection
        let draggedType = null;
        let isDragging = false;
        let isMultiDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let multiDragOffsets = []; // Store offsets for each selected component
        let history = [];
        let historyIndex = -1;
        let componentIdCounter = 1;
        let isResizing = false;
        let resizeHandle = null;
        let resizeStart = { x: 0, y: 0, width: 0, height: 0 };
        let currentTheme = 'default';

        // Marquee selection
        let isMarqueeSelecting = false;
        let marqueeJustFinished = false;
        let marqueeStart = { x: 0, y: 0 };
        let marqueeEl = null;

        // Theme management
        function changeTheme(theme) {
            currentTheme = theme;
            if (theme === 'default') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }
            // Also apply to canvas for export
            const canvas = document.getElementById('canvas');
            if (theme === 'default') {
                canvas.removeAttribute('data-theme');
            } else {
                canvas.setAttribute('data-theme', theme);
            }
            showToast(`Theme changed to: ${getThemeName(theme)}`, 'success');
        }

        function getThemeName(theme) {
            const names = {
                'default': 'Default',
                'aj': 'AJ Style (Teal)',
                'metronic': 'Metronic (KeenThemes)',
                'blue': 'Blue',
                'purple': 'Purple',
                'gray': 'Gray'
            };
            return names[theme] || theme;
        }

        // Canvas setup
        const canvas = document.getElementById('canvas');
        const propertiesContent = document.getElementById('propertiesContent');
        const contextMenu = document.getElementById('contextMenu');
        const fileInput = document.getElementById('fileInput');

        // Drag from palette
        document.querySelectorAll('.component-item').forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedType = item.dataset.type;
                e.dataTransfer.effectAllowed = 'copy';
            });

            item.addEventListener('dragend', () => {
                draggedType = null;
            });
        });

        // Canvas drop zone
        canvas.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            canvas.classList.add('drag-over');
        });

        canvas.addEventListener('dragleave', () => {
            canvas.classList.remove('drag-over');
        });

        canvas.addEventListener('drop', (e) => {
            e.preventDefault();
            canvas.classList.remove('drag-over');

            if (draggedType) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                addComponent(draggedType, x, y);
            }
        });

        // Click on canvas to deselect
        // Marquee selection - mouse down on canvas
        canvas.addEventListener('mousedown', (e) => {
            // Skip if clicking on resize handles
            if (e.target.classList.contains('canvas-resize-handle')) return;
            if (e.target.classList.contains('resize-handle')) return;

            // Only start marquee if clicking directly on canvas background
            // (not on dropped components or their children)
            const isOnCanvas = e.target === canvas ||
                               e.target.id === 'marqueeSelection' ||
                               e.target.closest('.canvas') === canvas && !e.target.closest('.dropped-component');

            if (isOnCanvas && !e.target.closest('.dropped-component')) {
                e.preventDefault();
                marqueeEl = document.getElementById('marqueeSelection');
                const rect = canvas.getBoundingClientRect();
                const container = canvas.parentElement; // canvas-container

                marqueeStart = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                isMarqueeSelecting = true;

                marqueeEl.style.left = marqueeStart.x + 'px';
                marqueeEl.style.top = marqueeStart.y + 'px';
                marqueeEl.style.width = '0px';
                marqueeEl.style.height = '0px';
                marqueeEl.style.display = 'block';

                // Clear selection unless holding Shift
                if (!e.shiftKey) {
                    clearSelection();
                }
            }
        });

        // Marquee selection - mouse move
        document.addEventListener('mousemove', (e) => {
            if (!isMarqueeSelecting || !marqueeEl) return;

            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            const x = Math.min(marqueeStart.x, currentX);
            const y = Math.min(marqueeStart.y, currentY);
            const width = Math.abs(currentX - marqueeStart.x);
            const height = Math.abs(currentY - marqueeStart.y);

            marqueeEl.style.left = x + 'px';
            marqueeEl.style.top = y + 'px';
            marqueeEl.style.width = width + 'px';
            marqueeEl.style.height = height + 'px';
        });

        // Marquee selection - mouse up
        document.addEventListener('mouseup', (e) => {
            if (isMarqueeSelecting && marqueeEl) {
                const marqueeWidth = parseInt(marqueeEl.style.width) || 0;
                const marqueeHeight = parseInt(marqueeEl.style.height) || 0;

                // Only process if marquee has some size (not just a click)
                if (marqueeWidth > 5 || marqueeHeight > 5) {
                    const marqueeRect = {
                        left: parseInt(marqueeEl.style.left),
                        top: parseInt(marqueeEl.style.top),
                        right: parseInt(marqueeEl.style.left) + marqueeWidth,
                        bottom: parseInt(marqueeEl.style.top) + marqueeHeight
                    };

                    // Find components that intersect with marquee
                    const selectedIds = [];
                    components.forEach(comp => {
                        const compRect = {
                            left: comp.x,
                            top: comp.y,
                            right: comp.x + comp.width,
                            bottom: comp.y + comp.height
                        };

                        // Check intersection
                        if (!(compRect.right < marqueeRect.left ||
                              compRect.left > marqueeRect.right ||
                              compRect.bottom < marqueeRect.top ||
                              compRect.top > marqueeRect.bottom)) {
                            selectedIds.push(comp.id);
                        }
                    });

                    if (selectedIds.length > 0) {
                        selectMultipleComponents(selectedIds);
                    }

                    marqueeJustFinished = true;
                    setTimeout(() => { marqueeJustFinished = false; }, 100);
                }

                marqueeEl.style.display = 'none';
                isMarqueeSelecting = false;
            }
        });

        canvas.addEventListener('click', (e) => {
            // Don't clear if marquee just finished or if clicking on component
            if (marqueeJustFinished) return;
            if (e.target.closest('.dropped-component')) return;
            if (e.target === canvas) {
                clearSelection();
            }
        });

        // Hide context menu on click
        document.addEventListener('click', () => {
            contextMenu.classList.add('hidden');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Delete selected components
            if (e.key === 'Delete' && selectedComponents.length > 0) {
                deleteSelectedComponents();
            }
            // Ctrl+D to duplicate selected
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                if (selectedComponents.length > 0) {
                    duplicateSelectedComponents();
                }
            }
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        });

        // Add component to canvas
        function addComponent(type, x, y) {
            const id = `comp_${componentIdCounter++}`;
            const component = {
                id,
                type,
                x,
                y,
                width: getDefaultWidth(type),
                height: getDefaultHeight(type),
                properties: getDefaultProperties(type)
            };

            components.push(component);
            renderComponent(component);
            selectComponent(id);
            saveHistory();
            autoResizeCanvas();
        }

        function getDefaultWidth(type) {
            const widths = {
                label: 100,
                title: 200,
                textbox: 200,
                textarea: 300,
                datepicker: 200,
                dropdown: 200,
                checkbox: 150,
                radio: 150,
                button: 100,
                iconbutton: 36,
                table: 500,
                tabs: 400,
                panel: 300,
                annotation: 150,
                notebox: 200,
                image: 300
            };
            return widths[type] || 100;
        }

        function getDefaultHeight(type) {
            const heights = {
                label: 30,
                title: 40,
                textbox: 36,
                textarea: 80,
                datepicker: 36,
                dropdown: 36,
                checkbox: 30,
                radio: 30,
                button: 36,
                iconbutton: 36,
                table: 150,
                tabs: 200,
                panel: 150,
                annotation: 50,
                notebox: 60,
                image: 200
            };
            return heights[type] || 30;
        }

        function getDefaultProperties(type) {
            const props = {
                label: { text: 'Label Text', fontSize: 14, bold: false },
                title: { text: 'Page Title', fontSize: 18 },
                textbox: { placeholder: 'Enter text...', width: 200, required: false, fieldName: 'field_name' },
                textarea: { placeholder: 'Enter text...', rows: 3, fieldName: 'field_name' },
                datepicker: { placeholder: 'dd/mm/yyyy', fieldName: 'date_field' },
                dropdown: { placeholder: 'Select...', options: 'Option 1, Option 2, Option 3', fieldName: 'dropdown_field' },
                checkbox: { label: 'Checkbox label', checked: false, fieldName: 'checkbox_field' },
                radio: { label: 'Radio label', group: 'group1', fieldName: 'radio_field' },
                button: { text: 'Button', style: 'default', action: 'onClick' },
                iconbutton: { icon: 'edit', iconType: 'keenicons', tooltip: 'Edit', action: 'onEdit' },
                table: {
                    columns: 'Column 1, Column 2, Column 3',
                    rows: 3,
                    fieldName: 'table_data',
                    showRowIcons: true,
                    rowIconsPosition: 'left',
                    rowIcons: 'üü°, üü¢üü†',
                    hasActionColumn: true,
                    actionColumnPosition: 'left',
                    actionIcons: 'edit, delete',
                    actionIconType: 'keenicons'
                },
                tabs: { tabs: 'Tab 1, Tab 2, Tab 3', activeTab: 0 },
                panel: { title: 'Panel Title' },
                annotation: { text: 'Annotation note', direction: 'right' },
                notebox: { text: 'Note: Important information here' },
                image: { src: '', alt: 'Image', objectFit: 'contain' }
            };
            return props[type] || {};
        }

        // Render component on canvas
        function renderComponent(comp) {
            const el = document.createElement('div');
            el.id = comp.id;
            el.className = 'dropped-component';
            el.style.left = comp.x + 'px';
            el.style.top = comp.y + 'px';
            el.style.width = comp.width + 'px';
            el.style.height = comp.height + 'px';

            el.innerHTML = getComponentHTML(comp);

            // Event listeners
            el.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) return;
                e.stopPropagation();

                // Ctrl+click to add to selection
                if (e.ctrlKey || e.metaKey) {
                    selectComponent(comp.id, true);
                } else if (!selectedComponents.some(c => c.id === comp.id)) {
                    // If clicking on a non-selected component, select only it
                    selectComponent(comp.id);
                }
                // If clicking on an already selected component (part of multi-selection), just start drag
                startDrag(e, comp.id);
            });

            el.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                // Only change selection if this component is NOT already part of multi-selection
                const isInMultiSelection = selectedComponents.some(c => c.id === comp.id) && selectedComponents.length > 1;
                if (!isInMultiSelection) {
                    selectComponent(comp.id);
                }
                showContextMenu(e.clientX, e.clientY);
            });

            canvas.appendChild(el);
            addResizeHandles(el, comp);
        }

        function getComponentHTML(comp) {
            const p = comp.properties;

            switch (comp.type) {
                case 'label':
                    const labelText = (p.text || '').replace(/\n/g, '<br>');
                    return `<div class="comp-label" contenteditable="true" data-comp-id="${comp.id}" style="font-size: ${p.fontSize}px; font-weight: ${p.bold ? 'bold' : 'normal'}" onblur="saveLabelText(this)" onkeydown="handleLabelKeydown(event, this)">${labelText}</div>`;

                case 'title':
                    return `<div class="comp-title" contenteditable="true" data-comp-id="${comp.id}" style="font-size: ${p.fontSize}px" onblur="saveLabelText(this)" onkeydown="handleLabelKeydown(event, this)">${p.text}</div>`;

                case 'textbox':
                    return `<input type="text" class="comp-textbox" placeholder="${p.placeholder}" style="width: 100%">`;

                case 'textarea':
                    return `<textarea class="comp-textarea" placeholder="${p.placeholder}" style="width: 100%; height: 100%"></textarea>`;

                case 'datepicker':
                    return `<div class="comp-datepicker">
                        <input type="text" placeholder="${p.placeholder}">
                        <div class="calendar-icon">üìÖ</div>
                    </div>`;

                case 'dropdown':
                    return `<div class="comp-dropdown-wrapper">
                        <select class="comp-dropdown">
                            <option value="">${p.placeholder}</option>
                            ${p.options.split(',').map(opt => `<option>${opt.trim()}</option>`).join('')}
                        </select>
                    </div>`;

                case 'checkbox':
                    return `<label class="comp-checkbox">
                        <input type="checkbox" ${p.checked ? 'checked' : ''}>
                        <span>${p.label}</span>
                    </label>`;

                case 'radio':
                    return `<label class="comp-radio">
                        <input type="radio" name="${p.group}">
                        <span>${p.label}</span>
                    </label>`;

                case 'button':
                    const btnClass = p.style === 'default' ? '' : p.style;
                    return `<button class="comp-button ${btnClass}">${p.text}</button>`;

                case 'iconbutton':
                    const emojiIcons = {
                        edit: '‚úèÔ∏è',
                        delete: 'üóëÔ∏è',
                        view: 'üëÅÔ∏è',
                        save: 'üíæ',
                        add: '‚ûï',
                        search: 'üîç',
                        check: '‚úÖ',
                        cancel: '‚ùå',
                        print: 'üñ®Ô∏è',
                        copy: 'üìã',
                        refresh: 'üîÑ',
                        download: '‚¨áÔ∏è',
                        upload: '‚¨ÜÔ∏è',
                        settings: '‚öôÔ∏è',
                        user: 'üë§',
                        calendar: 'üìÖ',
                        filter: 'üîΩ',
                        sort: '‚ÜïÔ∏è'
                    };
                    const keenIcons = {
                        edit: 'ki-notepad-edit',
                        delete: 'ki-trash',
                        view: 'ki-eye',
                        save: 'ki-file-down',
                        add: 'ki-plus-squared',
                        search: 'ki-magnifier',
                        check: 'ki-check',
                        cancel: 'ki-cross',
                        print: 'ki-printer',
                        copy: 'ki-copy',
                        refresh: 'ki-arrows-circle',
                        download: 'ki-arrow-down',
                        upload: 'ki-arrow-up',
                        settings: 'ki-setting-2',
                        user: 'ki-user',
                        calendar: 'ki-calendar',
                        filter: 'ki-filter',
                        sort: 'ki-arrow-up-down'
                    };
                    const iconBtnClass = p.icon === 'delete' ? 'delete' : p.icon === 'view' ? 'view' : p.icon === 'save' ? 'save' : 'edit';

                    if (p.iconType === 'keenicons') {
                        const kiIcon = keenIcons[p.icon] || 'ki-notepad-edit';
                        return `<div class="comp-icon-btn ${iconBtnClass}" title="${p.tooltip}"><i class="ki-outline ${kiIcon}" style="font-size: 18px;"></i></div>`;
                    } else {
                        return `<div class="comp-icon-btn ${iconBtnClass}" title="${p.tooltip}">${emojiIcons[p.icon] || '‚úèÔ∏è'}</div>`;
                    }

                case 'table':
                    const cols = p.columns.split(',').map(c => c.trim());
                    const rowIconsList = p.rowIcons ? p.rowIcons.split(',').map(r => r.trim()) : [];
                    const actionIconsList = p.actionIcons ? p.actionIcons.split(',').map(a => a.trim()) : [];
                    const rowIconsPos = p.rowIconsPosition || 'left';
                    const actionPos = p.actionColumnPosition || 'right';

                    // Helper to generate action cell
                    const getActionCell = (isHeader) => {
                        if (!p.hasActionColumn) return '';
                        if (isHeader) {
                            return '<th style="width: 80px;"></th>';
                        }
                        const emojiMap = {
                            'edit': '‚úèÔ∏è',
                            'delete': 'üóëÔ∏è',
                            'view': 'üëÅÔ∏è',
                            'save': 'üíæ',
                            'add': '‚ûï',
                            'check': '‚úÖ',
                            'cancel': '‚ùå',
                            'print': 'üñ®Ô∏è',
                            'copy': 'üìã',
                            'refresh': 'üîÑ',
                            'download': '‚¨áÔ∏è',
                            'upload': '‚¨ÜÔ∏è',
                            'settings': '‚öôÔ∏è'
                        };
                        const keenIconMap = {
                            'edit': 'ki-notepad-edit',
                            'delete': 'ki-trash',
                            'view': 'ki-eye',
                            'save': 'ki-file-down',
                            'add': 'ki-plus-squared',
                            'check': 'ki-check',
                            'cancel': 'ki-cross',
                            'print': 'ki-printer',
                            'copy': 'ki-copy',
                            'refresh': 'ki-arrows-circle',
                            'download': 'ki-arrow-down',
                            'upload': 'ki-arrow-up',
                            'settings': 'ki-setting-2'
                        };
                        let actionsHTML = '<td style="text-align: center;">';
                        actionIconsList.forEach(action => {
                            if (p.actionIconType === 'keenicons') {
                                const kiIcon = keenIconMap[action] || 'ki-dots-horizontal';
                                actionsHTML += `<span style="cursor: pointer; margin: 0 4px;"><i class="ki-outline ${kiIcon}" style="font-size: 16px; color: var(--primary-color, #3b82f6);"></i></span>`;
                            } else {
                                actionsHTML += `<span style="cursor: pointer; margin: 0 2px;">${emojiMap[action] || action}</span>`;
                            }
                        });
                        actionsHTML += '</td>';
                        return actionsHTML;
                    };

                    // Helper to generate row icons cell
                    const getRowIconCell = (isHeader, rowIndex) => {
                        if (!p.showRowIcons) return '';
                        if (isHeader) {
                            return '<th style="width: 50px;"></th>';
                        }
                        const icons = rowIconsList[rowIndex] || rowIconsList[0] || '‚ö™';
                        return `<td style="text-align: center;">${icons}</td>`;
                    };

                    let tableHTML = '<table class="comp-table"><thead><tr>';

                    // Header row - left columns first
                    if (p.showRowIcons && rowIconsPos === 'left') tableHTML += getRowIconCell(true);
                    if (p.hasActionColumn && actionPos === 'left') tableHTML += getActionCell(true);

                    cols.forEach(col => tableHTML += `<th>${col}</th>`);

                    // Header row - right columns
                    if (p.showRowIcons && rowIconsPos === 'right') tableHTML += getRowIconCell(true);
                    if (p.hasActionColumn && actionPos === 'right') tableHTML += getActionCell(true);

                    tableHTML += '</tr></thead><tbody>';

                    for (let i = 0; i < p.rows; i++) {
                        tableHTML += '<tr>';

                        // Left columns first
                        if (p.showRowIcons && rowIconsPos === 'left') tableHTML += getRowIconCell(false, i);
                        if (p.hasActionColumn && actionPos === 'left') tableHTML += getActionCell(false);

                        cols.forEach(() => tableHTML += '<td></td>');

                        // Right columns
                        if (p.showRowIcons && rowIconsPos === 'right') tableHTML += getRowIconCell(false, i);
                        if (p.hasActionColumn && actionPos === 'right') tableHTML += getActionCell(false);

                        tableHTML += '</tr>';
                    }
                    tableHTML += '</tbody></table>';
                    return tableHTML;

                case 'tabs':
                    const tabNames = p.tabs.split(',').map(t => t.trim());
                    let tabsHTML = '<div class="comp-tabs"><div class="tab-header">';
                    tabNames.forEach((tab, i) => {
                        tabsHTML += `<div class="tab-item ${i === p.activeTab ? 'active' : ''}">${tab}</div>`;
                    });
                    tabsHTML += '</div><div class="tab-content">Tab content area</div></div>';
                    return tabsHTML;

                case 'panel':
                    return `<div class="comp-panel" style="width: 100%; height: 100%">
                        <div class="panel-header">${p.title}</div>
                        <div class="panel-body"></div>
                    </div>`;

                case 'annotation':
                    return `<div class="comp-annotation">
                        <div style="position: relative; display: flex; align-items: center; gap: 8px;">
                            <div style="width: 80px; height: 2px; background: #3b82f6; position: relative;">
                                <div style="position: absolute; right: -6px; top: -4px; width: 0; height: 0; border-left: 8px solid #3b82f6; border-top: 5px solid transparent; border-bottom: 5px solid transparent;"></div>
                            </div>
                            <div class="annotation-box">${p.text}</div>
                        </div>
                    </div>`;

                case 'notebox':
                    return `<div class="annotation-box" style="width: 100%">${p.text}</div>`;

                case 'image':
                    if (p.src) {
                        return `<img class="comp-image" src="${p.src}" alt="${p.alt || 'Image'}" style="object-fit: ${p.objectFit || 'contain'}">`;
                    } else {
                        return `<div class="comp-image-placeholder" onclick="selectImageForComponent('${comp.id}')">
                            <span style="font-size: 32px;">üñºÔ∏è</span>
                            <span style="font-size: 12px; margin-top: 8px;">Click to select image</span>
                        </div>`;
                    }

                default:
                    return `<div>${comp.type}</div>`;
            }
        }

        function addResizeHandles(el, comp) {
            const handles = ['se', 'e', 's'];
            handles.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${pos}`;
                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    startResize(e, comp.id, pos);
                });
                el.appendChild(handle);
            });
        }

        function startResize(e, compId, handlePos) {
            isResizing = true;
            resizeHandle = handlePos;
            const comp = components.find(c => c.id === compId);
            resizeStart = {
                x: e.clientX,
                y: e.clientY,
                width: comp.width,
                height: comp.height
            };
            selectComponent(compId);

            const onMouseMove = (e) => {
                if (!isResizing) return;

                const dx = e.clientX - resizeStart.x;
                const dy = e.clientY - resizeStart.y;

                if (resizeHandle.includes('e')) {
                    comp.width = Math.max(50, resizeStart.width + dx);
                }
                if (resizeHandle.includes('s')) {
                    comp.height = Math.max(30, resizeStart.height + dy);
                }

                updateComponentElement(comp);
                autoResizeCanvas();
            };

            const onMouseUp = () => {
                isResizing = false;
                saveHistory();
                autoResizeCanvas();
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // Select component
        function selectComponent(id, addToSelection = false) {
            if (!addToSelection) {
                // Clear all selections
                document.querySelectorAll('.dropped-component').forEach(el => {
                    el.classList.remove('selected');
                    el.classList.remove('multi-selected');
                });
                selectedComponents = [];
            }

            if (id) {
                const el = document.getElementById(id);
                const comp = components.find(c => c.id === id);

                if (addToSelection) {
                    // Toggle selection
                    const idx = selectedComponents.findIndex(c => c.id === id);
                    if (idx >= 0) {
                        selectedComponents.splice(idx, 1);
                        if (el) el.classList.remove('multi-selected');
                    } else {
                        if (comp) selectedComponents.push(comp);
                        if (el) el.classList.add('multi-selected');
                    }
                    // Update primary selection
                    selectedComponent = selectedComponents.length > 0 ? selectedComponents[0] : null;
                } else {
                    if (el) el.classList.add('selected');
                    selectedComponent = comp;
                    selectedComponents = comp ? [comp] : [];
                }
                showProperties(selectedComponent);
            } else {
                selectedComponent = null;
                selectedComponents = [];
                showProperties(null);
            }
        }

        // Clear all selections
        function clearSelection() {
            document.querySelectorAll('.dropped-component').forEach(el => {
                el.classList.remove('selected');
                el.classList.remove('multi-selected');
            });
            selectedComponent = null;
            selectedComponents = [];
            showProperties(null);
        }

        // Select multiple components (from marquee)
        function selectMultipleComponents(compIds) {
            clearSelection();
            compIds.forEach((id, index) => {
                const el = document.getElementById(id);
                const comp = components.find(c => c.id === id);
                if (el && comp) {
                    el.classList.add('multi-selected');
                    selectedComponents.push(comp);
                }
            });
            if (selectedComponents.length > 0) {
                selectedComponent = selectedComponents[0];
                showProperties(selectedComponent);
            }
        }

        // Drag component
        function startDrag(e, compId) {
            const comp = components.find(c => c.id === compId);
            const el = document.getElementById(compId);
            const rect = el.getBoundingClientRect();

            // Check if this component is part of multi-selection
            const isInMultiSelection = selectedComponents.some(c => c.id === compId) && selectedComponents.length > 1;

            if (isInMultiSelection) {
                // Multi-drag mode
                isMultiDragging = true;
                isDragging = false;

                const canvasRect = canvas.getBoundingClientRect();
                const startX = e.clientX - canvasRect.left;
                const startY = e.clientY - canvasRect.top;

                // Store initial positions of all selected components
                multiDragOffsets = selectedComponents.map(c => ({
                    comp: c,
                    offsetX: c.x - startX,
                    offsetY: c.y - startY
                }));

                const onMouseMove = (moveE) => {
                    if (!isMultiDragging) return;

                    const canvasRect = canvas.getBoundingClientRect();
                    const currentX = moveE.clientX - canvasRect.left;
                    const currentY = moveE.clientY - canvasRect.top;

                    multiDragOffsets.forEach(item => {
                        item.comp.x = Math.max(0, currentX + item.offsetX);
                        item.comp.y = Math.max(0, currentY + item.offsetY);

                        const compEl = document.getElementById(item.comp.id);
                        if (compEl) {
                            compEl.style.left = item.comp.x + 'px';
                            compEl.style.top = item.comp.y + 'px';
                        }
                    });

                    autoResizeCanvas();
                };

                const onMouseUp = () => {
                    isMultiDragging = false;
                    multiDragOffsets = [];
                    saveHistory();
                    autoResizeCanvas();
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            } else {
                // Single drag mode
                isDragging = true;

                dragOffset = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };

                const onMouseMove = (moveE) => {
                    if (!isDragging) return;

                    const canvasRect = canvas.getBoundingClientRect();
                    comp.x = moveE.clientX - canvasRect.left - dragOffset.x;
                    comp.y = moveE.clientY - canvasRect.top - dragOffset.y;

                    // Keep minimum bounds (allow expansion to the right and bottom)
                    comp.x = Math.max(0, comp.x);
                    comp.y = Math.max(0, comp.y);

                    el.style.left = comp.x + 'px';
                    el.style.top = comp.y + 'px';

                    // Auto-resize canvas while dragging
                    autoResizeCanvas();
                };

                const onMouseUp = () => {
                    isDragging = false;
                    saveHistory();
                    autoResizeCanvas();
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
        }

        // Show properties panel
        function showProperties(comp) {
            if (!comp) {
                propertiesContent.innerHTML = '<p style="color: #94a3b8; font-size: 13px;">Select a component to edit its properties</p>';
                return;
            }

            let html = `
                <div class="property-group">
                    <label>Type</label>
                    <input type="text" value="${comp.type}" disabled>
                </div>
                <div class="property-row">
                    <div class="property-group">
                        <label>X</label>
                        <input type="number" id="prop_x" value="${Math.round(comp.x)}" onchange="updatePosition('x', this.value)">
                    </div>
                    <div class="property-group">
                        <label>Y</label>
                        <input type="number" id="prop_y" value="${Math.round(comp.y)}" onchange="updatePosition('y', this.value)">
                    </div>
                </div>
                <div class="property-row">
                    <div class="property-group">
                        <label>Width</label>
                        <input type="number" id="prop_width" value="${comp.width}" onchange="updateSize('width', this.value)">
                    </div>
                    <div class="property-group">
                        <label>Height</label>
                        <input type="number" id="prop_height" value="${comp.height}" onchange="updateSize('height', this.value)">
                    </div>
                </div>
            `;

            // Add type-specific properties
            html += getPropertiesHTML(comp);

            propertiesContent.innerHTML = html;
        }

        function getPropertiesHTML(comp) {
            const p = comp.properties;
            let html = '<hr style="margin: 16px 0; border: none; border-top: 1px solid #e2e8f0;">';

            switch (comp.type) {
                case 'label':
                    html += `
                        <div class="property-group">
                            <label>Text</label>
                            <textarea rows="3" onchange="updateProp('text', this.value)">${p.text}</textarea>
                        </div>
                        <div class="property-group">
                            <label>Font Size</label>
                            <input type="number" value="${p.fontSize}" onchange="updateProp('fontSize', parseInt(this.value))">
                        </div>
                        <div class="property-group">
                            <label>Bold</label>
                            <select onchange="updateProp('bold', this.value === 'true')">
                                <option value="false" ${!p.bold ? 'selected' : ''}>No</option>
                                <option value="true" ${p.bold ? 'selected' : ''}>Yes</option>
                            </select>
                    `;
                    break;

                case 'title':
                    html += `
                        <div class="property-group">
                            <label>Text</label>
                            <input type="text" value="${p.text}" onchange="updateProp('text', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Font Size</label>
                            <input type="number" value="${p.fontSize}" onchange="updateProp('fontSize', parseInt(this.value))">
                        </div>
                    `;
                    break;

                case 'textbox':
                case 'textarea':
                    html += `
                        <div class="property-group">
                            <label>Field Name</label>
                            <input type="text" value="${p.fieldName || ''}" onchange="updateProp('fieldName', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Placeholder</label>
                            <input type="text" value="${p.placeholder}" onchange="updateProp('placeholder', this.value)">
                        </div>
                    `;
                    if (comp.type === 'textbox') {
                        html += `
                            <div class="property-group">
                                <label>Required</label>
                                <select onchange="updateProp('required', this.value === 'true')">
                                    <option value="false" ${!p.required ? 'selected' : ''}>No</option>
                                    <option value="true" ${p.required ? 'selected' : ''}>Yes</option>
                                </select>
                            </div>
                        `;
                    }
                    break;

                case 'datepicker':
                    html += `
                        <div class="property-group">
                            <label>Field Name</label>
                            <input type="text" value="${p.fieldName || ''}" onchange="updateProp('fieldName', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Placeholder</label>
                            <input type="text" value="${p.placeholder}" onchange="updateProp('placeholder', this.value)">
                        </div>
                    `;
                    break;

                case 'dropdown':
                    html += `
                        <div class="property-group">
                            <label>Field Name</label>
                            <input type="text" value="${p.fieldName || ''}" onchange="updateProp('fieldName', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Placeholder</label>
                            <input type="text" value="${p.placeholder}" onchange="updateProp('placeholder', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Options (comma separated)</label>
                            <textarea rows="3" onchange="updateProp('options', this.value)">${p.options}</textarea>
                        </div>
                    `;
                    break;

                case 'checkbox':
                case 'radio':
                    html += `
                        <div class="property-group">
                            <label>Field Name</label>
                            <input type="text" value="${p.fieldName || ''}" onchange="updateProp('fieldName', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Label</label>
                            <input type="text" value="${p.label}" onchange="updateProp('label', this.value)">
                        </div>
                    `;
                    if (comp.type === 'radio') {
                        html += `
                            <div class="property-group">
                                <label>Group Name</label>
                                <input type="text" value="${p.group}" onchange="updateProp('group', this.value)">
                            </div>
                        `;
                    }
                    break;

                case 'button':
                    html += `
                        <div class="property-group">
                            <label>Text</label>
                            <input type="text" value="${p.text}" onchange="updateProp('text', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Style</label>
                            <select onchange="updateProp('style', this.value)">
                                <option value="default" ${p.style === 'default' ? 'selected' : ''}>Default</option>
                                <option value="primary" ${p.style === 'primary' ? 'selected' : ''}>Primary (Blue)</option>
                                <option value="success" ${p.style === 'success' ? 'selected' : ''}>Success (Green)</option>
                                <option value="danger" ${p.style === 'danger' ? 'selected' : ''}>Danger (Red)</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Action</label>
                            <input type="text" value="${p.action || ''}" onchange="updateProp('action', this.value)">
                        </div>
                    `;
                    break;

                case 'iconbutton':
                    html += `
                        <div class="property-group">
                            <label>Icon Type</label>
                            <select onchange="updateProp('iconType', this.value)">
                                <option value="emoji" ${(p.iconType || 'emoji') === 'emoji' ? 'selected' : ''}>Emoji</option>
                                <option value="keenicons" ${p.iconType === 'keenicons' ? 'selected' : ''}>KeenIcons</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Icon</label>
                            <select onchange="updateProp('icon', this.value)">
                                <option value="edit" ${p.icon === 'edit' ? 'selected' : ''}>Edit</option>
                                <option value="delete" ${p.icon === 'delete' ? 'selected' : ''}>Delete</option>
                                <option value="view" ${p.icon === 'view' ? 'selected' : ''}>View</option>
                                <option value="save" ${p.icon === 'save' ? 'selected' : ''}>Save</option>
                                <option value="add" ${p.icon === 'add' ? 'selected' : ''}>Add</option>
                                <option value="search" ${p.icon === 'search' ? 'selected' : ''}>Search</option>
                                <option value="check" ${p.icon === 'check' ? 'selected' : ''}>Check</option>
                                <option value="cancel" ${p.icon === 'cancel' ? 'selected' : ''}>Cancel</option>
                                <option value="print" ${p.icon === 'print' ? 'selected' : ''}>Print</option>
                                <option value="copy" ${p.icon === 'copy' ? 'selected' : ''}>Copy</option>
                                <option value="refresh" ${p.icon === 'refresh' ? 'selected' : ''}>Refresh</option>
                                <option value="download" ${p.icon === 'download' ? 'selected' : ''}>Download</option>
                                <option value="upload" ${p.icon === 'upload' ? 'selected' : ''}>Upload</option>
                                <option value="settings" ${p.icon === 'settings' ? 'selected' : ''}>Settings</option>
                                <option value="user" ${p.icon === 'user' ? 'selected' : ''}>User</option>
                                <option value="calendar" ${p.icon === 'calendar' ? 'selected' : ''}>Calendar</option>
                                <option value="filter" ${p.icon === 'filter' ? 'selected' : ''}>Filter</option>
                                <option value="sort" ${p.icon === 'sort' ? 'selected' : ''}>Sort</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Tooltip</label>
                            <input type="text" value="${p.tooltip}" onchange="updateProp('tooltip', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Action</label>
                            <input type="text" value="${p.action || ''}" onchange="updateProp('action', this.value)">
                        </div>
                    `;
                    break;

                case 'table':
                    html += `
                        <div class="property-group">
                            <label>Field Name</label>
                            <input type="text" value="${p.fieldName || ''}" onchange="updateProp('fieldName', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Columns (comma separated)</label>
                            <textarea rows="3" onchange="updateProp('columns', this.value)">${p.columns}</textarea>
                        </div>
                        <div class="property-group">
                            <label>Sample Rows</label>
                            <input type="number" value="${p.rows}" min="1" max="10" onchange="updateProp('rows', parseInt(this.value))">
                        </div>
                        <hr style="margin: 12px 0; border: none; border-top: 1px solid #e2e8f0;">
                        <div class="property-group">
                            <label>Show Row Icons</label>
                            <select onchange="updateProp('showRowIcons', this.value === 'true')">
                                <option value="false" ${!p.showRowIcons ? 'selected' : ''}>No</option>
                                <option value="true" ${p.showRowIcons ? 'selected' : ''}>Yes</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Row Icons Position</label>
                            <select onchange="updateProp('rowIconsPosition', this.value)">
                                <option value="left" ${(p.rowIconsPosition || 'left') === 'left' ? 'selected' : ''}>Left</option>
                                <option value="right" ${p.rowIconsPosition === 'right' ? 'selected' : ''}>Right</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Row Icons (per row, comma separated)</label>
                            <textarea rows="2" onchange="updateProp('rowIcons', this.value)" placeholder="üü°, üü¢üü†, üîµ">${p.rowIcons || ''}</textarea>
                            <small style="color: #64748b; font-size: 11px;">Use: üü°üü¢üü†üîµüü£‚ö™üî¥ or combine like üü¢üü†</small>
                        </div>
                        <hr style="margin: 12px 0; border: none; border-top: 1px solid #e2e8f0;">
                        <div class="property-group">
                            <label>Show Action Column</label>
                            <select onchange="updateProp('hasActionColumn', this.value === 'true')">
                                <option value="false" ${!p.hasActionColumn ? 'selected' : ''}>No</option>
                                <option value="true" ${p.hasActionColumn ? 'selected' : ''}>Yes</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Action Column Position</label>
                            <select onchange="updateProp('actionColumnPosition', this.value)">
                                <option value="left" ${(p.actionColumnPosition || 'left') === 'left' ? 'selected' : ''}>Left</option>
                                <option value="right" ${p.actionColumnPosition === 'right' ? 'selected' : ''}>Right</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Action Icon Type</label>
                            <select onchange="updateProp('actionIconType', this.value)">
                                <option value="emoji" ${(p.actionIconType || 'emoji') === 'emoji' ? 'selected' : ''}>Emoji</option>
                                <option value="keenicons" ${p.actionIconType === 'keenicons' ? 'selected' : ''}>KeenIcons</option>
                            </select>
                        </div>
                        <div class="property-group">
                            <label>Action Icons (comma separated)</label>
                            <textarea rows="2" onchange="updateProp('actionIcons', this.value)" placeholder="edit, delete, view">${p.actionIcons || ''}</textarea>
                            <small style="color: #64748b; font-size: 11px;">Options: edit, delete, view, save, add, check, cancel, print, copy, refresh, download, upload, settings</small>
                        </div>
                    `;
                    break;

                case 'tabs':
                    html += `
                        <div class="property-group">
                            <label>Tab Names (comma separated)</label>
                            <textarea rows="2" onchange="updateProp('tabs', this.value)">${p.tabs}</textarea>
                        </div>
                        <div class="property-group">
                            <label>Active Tab Index</label>
                            <input type="number" value="${p.activeTab}" min="0" onchange="updateProp('activeTab', parseInt(this.value))">
                        </div>
                    `;
                    break;

                case 'panel':
                    html += `
                        <div class="property-group">
                            <label>Title</label>
                            <input type="text" value="${p.title}" onchange="updateProp('title', this.value)">
                        </div>
                    `;
                    break;

                case 'annotation':
                case 'notebox':
                    html += `
                        <div class="property-group">
                            <label>Note Text</label>
                            <textarea rows="3" onchange="updateProp('text', this.value)">${p.text}</textarea>
                        </div>
                    `;
                    break;

                case 'image':
                    html += `
                        <div class="property-group">
                            <label>Image</label>
                            <button class="toolbar-btn" onclick="selectImageForComponent('${comp.id}')" style="width: 100%;">
                                üì∑ ${p.src ? 'Change Image' : 'Select Image'}
                            </button>
                        </div>
                        ${p.src ? `
                        <div class="property-group">
                            <img src="${p.src}" style="max-width: 100%; max-height: 100px; border-radius: 4px; border: 1px solid #e2e8f0;">
                        </div>
                        ` : ''}
                        <div class="property-group">
                            <label>Alt Text</label>
                            <input type="text" value="${p.alt || ''}" onchange="updateProp('alt', this.value)">
                        </div>
                        <div class="property-group">
                            <label>Object Fit</label>
                            <select onchange="updateProp('objectFit', this.value)">
                                <option value="contain" ${(p.objectFit || 'contain') === 'contain' ? 'selected' : ''}>Contain</option>
                                <option value="cover" ${p.objectFit === 'cover' ? 'selected' : ''}>Cover</option>
                                <option value="fill" ${p.objectFit === 'fill' ? 'selected' : ''}>Fill</option>
                                <option value="none" ${p.objectFit === 'none' ? 'selected' : ''}>None (Original)</option>
                            </select>
                        </div>
                    `;
                    break;
            }

            return html;
        }

        function updatePosition(prop, value) {
            if (!selectedComponent) return;
            selectedComponent[prop] = parseInt(value);
            updateComponentElement(selectedComponent);
            saveHistory();
        }

        function updateSize(prop, value) {
            if (!selectedComponent) return;
            selectedComponent[prop] = parseInt(value);
            updateComponentElement(selectedComponent);
            saveHistory();
        }

        function updateProp(prop, value) {
            if (!selectedComponent) return;
            selectedComponent.properties[prop] = value;
            updateComponentElement(selectedComponent);
            showProperties(selectedComponent);
            saveHistory();
        }

        // Save label text from inline editing
        function saveLabelText(el) {
            const compId = el.dataset.compId;
            const comp = components.find(c => c.id === compId);
            if (!comp) return;

            // Convert <br> and <div> back to \n for storage
            let text = el.innerHTML
                .replace(/<div>/gi, '\n')
                .replace(/<\/div>/gi, '')
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/&nbsp;/g, ' ');

            // Remove HTML tags and decode entities
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = text;
            text = tempDiv.textContent || tempDiv.innerText || '';

            if (comp.properties.text !== text) {
                comp.properties.text = text;
                saveHistory();
                // Update properties panel if this component is selected
                if (selectedComponent && selectedComponent.id === compId) {
                    showProperties(comp);
                }
            }
        }

        // Handle keyboard events in label editing
        function handleLabelKeydown(e, el) {
            // Shift+Enter for new line (default behavior)
            // Enter without shift to finish editing
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                el.blur();
            }
            // Escape to cancel
            if (e.key === 'Escape') {
                const compId = el.dataset.compId;
                const comp = components.find(c => c.id === compId);
                if (comp) {
                    el.innerHTML = (comp.properties.text || '').replace(/\n/g, '<br>');
                }
                el.blur();
            }
        }

        function updateComponentElement(comp) {
            const el = document.getElementById(comp.id);
            if (!el) return;

            el.style.left = comp.x + 'px';
            el.style.top = comp.y + 'px';
            el.style.width = comp.width + 'px';
            el.style.height = comp.height + 'px';

            // Re-render inner HTML while preserving resize handles
            const handles = el.querySelectorAll('.resize-handle');
            el.innerHTML = getComponentHTML(comp);
            handles.forEach(h => el.appendChild(h.cloneNode(true)));

            // Re-attach resize handlers
            el.querySelectorAll('.resize-handle').forEach(handle => {
                const pos = handle.className.split(' ')[1];
                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    startResize(e, comp.id, pos);
                });
            });
        }

        // Context menu
        function showContextMenu(x, y) {
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.remove('hidden');
        }

        function duplicateComponent() {
            if (!selectedComponent) return;

            const newComp = JSON.parse(JSON.stringify(selectedComponent));
            newComp.id = `comp_${componentIdCounter++}`;
            newComp.x += 20;
            newComp.y += 20;

            components.push(newComp);
            renderComponent(newComp);
            selectComponent(newComp.id);
            saveHistory();
        }

        function deleteComponent() {
            if (!selectedComponent) return;

            const el = document.getElementById(selectedComponent.id);
            if (el) el.remove();

            components = components.filter(c => c.id !== selectedComponent.id);
            selectComponent(null);
            saveHistory();
        }

        // Delete all selected components
        function deleteSelectedComponents() {
            if (selectedComponents.length === 0) return;

            selectedComponents.forEach(comp => {
                const el = document.getElementById(comp.id);
                if (el) el.remove();
                components = components.filter(c => c.id !== comp.id);
            });

            clearSelection();
            saveHistory();
        }

        // Duplicate all selected components (Ctrl+D)
        function duplicateSelectedComponents() {
            if (selectedComponents.length === 0) return;

            const newComps = [];
            selectedComponents.forEach(comp => {
                const newComp = JSON.parse(JSON.stringify(comp));
                newComp.id = `comp_${componentIdCounter++}`;
                newComp.x += 20;
                newComp.y += 20;
                components.push(newComp);
                renderComponent(newComp);
                newComps.push(newComp);
            });

            // Select the new components
            selectMultipleComponents(newComps.map(c => c.id));
            saveHistory();
            showToast(`Duplicated ${newComps.length} component(s)`, 'success');
        }

        function bringToFront() {
            if (!selectedComponent) return;
            const el = document.getElementById(selectedComponent.id);
            if (el) {
                canvas.appendChild(el);
            }
        }

        function sendToBack() {
            if (!selectedComponent) return;
            const el = document.getElementById(selectedComponent.id);
            if (el) {
                canvas.insertBefore(el, canvas.firstChild);
            }
        }

        // History for undo/redo
        function saveHistory() {
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.stringify(components));
            historyIndex = history.length - 1;

            // Limit history size
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                loadFromHistory();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                loadFromHistory();
            }
        }

        function loadFromHistory() {
            components = JSON.parse(history[historyIndex]);
            rerenderCanvas();
        }

        function rerenderCanvas() {
            // Clear canvas
            canvas.querySelectorAll('.dropped-component').forEach(el => el.remove());

            // Re-render all components
            components.forEach(comp => renderComponent(comp));
            selectComponent(null);

            // Auto-resize canvas to fit all components
            autoResizeCanvas();
        }

        // Auto-resize canvas based on component positions
        function autoResizeCanvas() {
            const manualWidth = parseInt(document.getElementById('canvasWidth').value) || 1200;
            const manualHeight = parseInt(document.getElementById('canvasHeight').value) || 800;

            let maxRight = manualWidth;
            let maxBottom = manualHeight;

            components.forEach(comp => {
                const right = comp.x + comp.width + 100;  // 100px padding
                const bottom = comp.y + comp.height + 100;

                if (right > maxRight) maxRight = right;
                if (bottom > maxBottom) maxBottom = bottom;
            });

            canvas.style.width = maxRight + 'px';
            canvas.style.height = maxBottom + 'px';
            canvas.style.minWidth = maxRight + 'px';
            canvas.style.minHeight = maxBottom + 'px';

            // Update input fields if canvas expanded
            if (maxRight > manualWidth) {
                document.getElementById('canvasWidth').value = Math.ceil(maxRight / 100) * 100;
            }
            if (maxBottom > manualHeight) {
                document.getElementById('canvasHeight').value = Math.ceil(maxBottom / 100) * 100;
            }
        }

        // Manually set canvas size
        function setCanvasSize(showMessage = true) {
            const width = parseInt(document.getElementById('canvasWidth').value) || 1200;
            const height = parseInt(document.getElementById('canvasHeight').value) || 800;

            canvas.style.width = Math.max(400, width) + 'px';
            canvas.style.height = Math.max(300, height) + 'px';
            canvas.style.minWidth = Math.max(400, width) + 'px';
            canvas.style.minHeight = Math.max(300, height) + 'px';

            if (showMessage) {
                showToast(`Canvas size: ${width} x ${height}`, 'success');
            }
        }

        // Canvas resize drag functionality
        function initCanvasResize() {
            const resizeHandles = document.querySelectorAll('.canvas-resize-handle');
            let isResizingCanvas = false;
            let canvasResizeType = '';
            let canvasResizeStart = { x: 0, y: 0, width: 0, height: 0 };

            resizeHandles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    isResizingCanvas = true;
                    canvasResizeType = handle.dataset.resize;
                    canvasResizeStart = {
                        x: e.clientX,
                        y: e.clientY,
                        width: canvas.offsetWidth,
                        height: canvas.offsetHeight
                    };
                });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizingCanvas) return;

                const dx = e.clientX - canvasResizeStart.x;
                const dy = e.clientY - canvasResizeStart.y;

                let newWidth = canvasResizeStart.width;
                let newHeight = canvasResizeStart.height;

                if (canvasResizeType.includes('e')) {
                    newWidth = Math.max(400, canvasResizeStart.width + dx);
                }
                if (canvasResizeType.includes('s')) {
                    newHeight = Math.max(300, canvasResizeStart.height + dy);
                }

                canvas.style.width = newWidth + 'px';
                canvas.style.height = newHeight + 'px';
                canvas.style.minWidth = newWidth + 'px';
                canvas.style.minHeight = newHeight + 'px';

                document.getElementById('canvasWidth').value = newWidth;
                document.getElementById('canvasHeight').value = newHeight;
            });

            document.addEventListener('mouseup', () => {
                if (isResizingCanvas) {
                    isResizingCanvas = false;
                }
            });
        }

        // Fit canvas to components (shrink to fit)
        function fitCanvasToComponents() {
            if (components.length === 0) {
                document.getElementById('canvasWidth').value = 1200;
                document.getElementById('canvasHeight').value = 800;
                setCanvasSize();
                return;
            }

            let maxRight = 0;
            let maxBottom = 0;

            components.forEach(comp => {
                const right = comp.x + comp.width + 50;
                const bottom = comp.y + comp.height + 50;

                if (right > maxRight) maxRight = right;
                if (bottom > maxBottom) maxBottom = bottom;
            });

            // Round up to nearest 100
            const newWidth = Math.max(400, Math.ceil(maxRight / 100) * 100);
            const newHeight = Math.max(300, Math.ceil(maxBottom / 100) * 100);

            document.getElementById('canvasWidth').value = newWidth;
            document.getElementById('canvasHeight').value = newHeight;

            setCanvasSize(false);
            showToast(`Canvas fitted: ${newWidth} x ${newHeight}`, 'success');
        }

        // Save/Load JSON
        function saveDesign() {
            const design = {
                screenId: document.getElementById('screenName').value,
                screenTitle: document.getElementById('screenTitle').value,
                theme: currentTheme,
                canvasWidth: parseInt(document.getElementById('canvasWidth').value) || 1200,
                canvasHeight: parseInt(document.getElementById('canvasHeight').value) || 800,
                components: components,
                version: '1.0',
                createdAt: new Date().toISOString()
            };

            const json = JSON.stringify(design, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${design.screenId || 'screen'}.json`;
            a.click();

            URL.revokeObjectURL(url);
            showToast('Design saved successfully!', 'success');
        }

        function loadDesign() {
            fileInput.click();
        }

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const design = JSON.parse(e.target.result);

                    document.getElementById('screenName').value = design.screenId || '';
                    document.getElementById('screenTitle').value = design.screenTitle || '';
                    components = design.components || [];

                    // Load theme
                    if (design.theme) {
                        currentTheme = design.theme;
                        document.getElementById('themeSelect').value = design.theme;
                        changeTheme(design.theme);
                    }

                    // Load canvas size
                    if (design.canvasWidth) {
                        document.getElementById('canvasWidth').value = design.canvasWidth;
                    }
                    if (design.canvasHeight) {
                        document.getElementById('canvasHeight').value = design.canvasHeight;
                    }

                    // Find max component ID
                    componentIdCounter = 1;
                    components.forEach(c => {
                        const num = parseInt(c.id.replace('comp_', ''));
                        if (num >= componentIdCounter) componentIdCounter = num + 1;
                    });

                    rerenderCanvas();
                    saveHistory();
                    showToast('Design loaded successfully!', 'success');
                } catch (err) {
                    showToast('Error loading file: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        });

        function exportImage() {
            // Use html2canvas if available, otherwise show message
            if (typeof html2canvas !== 'undefined') {
                // Hide resize handles and selection before export
                const resizeHandles = canvas.querySelectorAll('.resize-handle');
                const canvasResizeHandles = canvas.querySelectorAll('.canvas-resize-handle');
                const selectedComponents = canvas.querySelectorAll('.dropped-component.selected');
                const allComponents = canvas.querySelectorAll('.dropped-component');

                // Store original states and hide handles
                resizeHandles.forEach(h => h.style.display = 'none');
                canvasResizeHandles.forEach(h => h.style.display = 'none');

                // Remove selection outline temporarily
                selectedComponents.forEach(c => c.classList.remove('selected'));

                // Remove hover outline by adding a temporary class
                allComponents.forEach(c => c.style.outline = 'none');

                // Also hide the dashed border of canvas
                const originalBorder = canvas.style.border;
                canvas.style.border = '1px solid #e2e8f0';

                html2canvas(canvas, {
                    backgroundColor: '#ffffff',
                    scale: 2 // Higher quality
                }).then(canvasEl => {
                    const link = document.createElement('a');
                    link.download = `${document.getElementById('screenName').value || 'screen'}.png`;
                    link.href = canvasEl.toDataURL();
                    link.click();

                    // Restore resize handles
                    resizeHandles.forEach(h => h.style.display = '');
                    canvasResizeHandles.forEach(h => h.style.display = '');

                    // Restore selection
                    selectedComponents.forEach(c => c.classList.add('selected'));

                    // Restore outline
                    allComponents.forEach(c => c.style.outline = '');

                    // Restore canvas border
                    canvas.style.border = originalBorder;

                    showToast('PNG exported successfully!', 'success');
                });
            } else {
                showToast('For PNG export, please add html2canvas library', 'error');
            }
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear all components?')) {
                components = [];
                rerenderCanvas();
                saveHistory();
                showToast('Canvas cleared', 'success');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================
        // Component Image Selection
        // ============================================

        let pendingImageComponentId = null;
        const componentImageInput = document.getElementById('componentImageInput');

        function selectImageForComponent(compId) {
            pendingImageComponentId = compId;
            componentImageInput.click();
        }

        componentImageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !pendingImageComponentId) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const base64 = event.target.result;
                const comp = components.find(c => c.id === pendingImageComponentId);
                if (comp) {
                    comp.properties.src = base64;

                    // Auto-adjust size based on image dimensions
                    const img = new Image();
                    img.onload = () => {
                        // Keep aspect ratio, max 500px width
                        const maxWidth = 500;
                        const maxHeight = 400;
                        let newWidth = img.width;
                        let newHeight = img.height;

                        if (newWidth > maxWidth) {
                            newHeight = (maxWidth / newWidth) * newHeight;
                            newWidth = maxWidth;
                        }
                        if (newHeight > maxHeight) {
                            newWidth = (maxHeight / newHeight) * newWidth;
                            newHeight = maxHeight;
                        }

                        comp.width = Math.round(newWidth);
                        comp.height = Math.round(newHeight);

                        updateComponentElement(comp);
                        showProperties(comp);
                        saveHistory();
                        autoResizeCanvas();
                    };
                    img.src = base64;
                }
                pendingImageComponentId = null;
            };
            reader.readAsDataURL(file);
            componentImageInput.value = '';
        });

        // ============================================
        // Import from Image Feature
        // ============================================

        let selectedImageBase64 = null;

        // Load API key from localStorage
        function loadApiKey() {
            const saved = localStorage.getItem('anthropic_api_key');
            if (saved) {
                document.getElementById('apiKeyInput').value = saved;
            }
        }

        // Save API key to localStorage
        function saveApiKey(key) {
            localStorage.setItem('anthropic_api_key', key);
        }

        function showImportImageModal() {
            document.getElementById('importImageModal').classList.remove('hidden');
            loadApiKey();
            updateAnalyzeButton();
        }

        function closeImportImageModal() {
            document.getElementById('importImageModal').classList.add('hidden');
            document.getElementById('importStatus').style.display = 'none';
            // Reset image preview
            selectedImageBase64 = null;
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('imagePlaceholder').style.display = 'block';
        }

        function updateAnalyzeButton() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = !apiKey || !selectedImageBase64;
        }

        // Image drop zone setup
        const imageDropZone = document.getElementById('imageDropZone');
        const imageInput = document.getElementById('imageInput');

        imageDropZone.addEventListener('click', () => imageInput.click());

        imageDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageDropZone.style.borderColor = '#3b82f6';
            imageDropZone.style.background = '#eff6ff';
        });

        imageDropZone.addEventListener('dragleave', () => {
            imageDropZone.style.borderColor = '#cbd5e1';
            imageDropZone.style.background = '#f8fafc';
        });

        imageDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            imageDropZone.style.borderColor = '#cbd5e1';
            imageDropZone.style.background = '#f8fafc';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFile(file);
            }
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        });

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                selectedImageBase64 = base64;

                // Show preview
                document.getElementById('imagePreview').src = base64;
                document.getElementById('imagePreviewContainer').style.display = 'block';
                document.getElementById('imagePlaceholder').style.display = 'none';

                updateAnalyzeButton();
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('apiKeyInput').addEventListener('input', updateAnalyzeButton);

        async function analyzeImage() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey || !selectedImageBase64) {
                showToast('Please provide API key and image', 'error');
                return;
            }

            // Save API key
            saveApiKey(apiKey);

            // Show loading
            document.getElementById('importStatus').style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;

            try {
                // Extract base64 data (remove data:image/...;base64, prefix)
                const base64Data = selectedImageBase64.split(',')[1];
                const mediaType = selectedImageBase64.match(/data:(.*?);/)[1];

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 8000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyze this UI screenshot and generate a JSON array of UI components that can recreate this design.

Each component should have this structure:
{
  "id": "comp_N",
  "type": "label|title|textbox|textarea|datepicker|dropdown|checkbox|radio|button|iconbutton|table|tabs|panel|annotation|notebox",
  "x": number (position from left in pixels),
  "y": number (position from top in pixels),
  "width": number,
  "height": number,
  "properties": { type-specific properties }
}

Component types and their properties:
- label: { text, fontSize (default 14), bold (boolean) }
- title: { text, fontSize (default 18) }
- textbox: { placeholder, fieldName, required (boolean) }
- textarea: { placeholder, fieldName, rows }
- datepicker: { placeholder, fieldName }
- dropdown: { placeholder, options (comma-separated), fieldName }
- checkbox: { label, fieldName, checked (boolean) }
- radio: { label, group, fieldName }
- button: { text, style (default|primary|success|danger), action }
- iconbutton: { icon (edit|delete|view|save|add|search|check|cancel|print|copy|refresh|download|upload|settings), iconType (emoji|keenicons), tooltip, action }
- table: { columns (comma-separated), rows (number), fieldName, showRowIcons (boolean), rowIconsPosition (left|right), rowIcons (comma-separated emojis), hasActionColumn (boolean), actionColumnPosition (left|right), actionIcons (comma-separated: edit,delete,view,etc), actionIconType (emoji|keenicons) }
- tabs: { tabs (comma-separated tab names), activeTab (index) }
- panel: { title }
- notebox: { text }

IMPORTANT:
1. Start component IDs from comp_1
2. Position components accurately based on the screenshot
3. Use Thai text if the screenshot contains Thai
4. Return ONLY valid JSON array, no markdown or explanation
5. Estimate canvas size needed (canvasWidth, canvasHeight)

Return format:
{
  "canvasWidth": number,
  "canvasHeight": number,
  "components": [...]
}`
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.content[0].text;

                // Parse JSON from response
                let parsed;
                try {
                    // Try to extract JSON from the response
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        parsed = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('No JSON found in response');
                    }
                } catch (parseErr) {
                    console.error('Parse error:', content);
                    throw new Error('Failed to parse AI response as JSON');
                }

                // Load the components
                if (parsed.components && Array.isArray(parsed.components)) {
                    components = parsed.components;

                    // Update canvas size
                    if (parsed.canvasWidth) {
                        document.getElementById('canvasWidth').value = parsed.canvasWidth;
                    }
                    if (parsed.canvasHeight) {
                        document.getElementById('canvasHeight').value = parsed.canvasHeight;
                    }

                    // Find max component ID
                    componentIdCounter = 1;
                    components.forEach(c => {
                        const num = parseInt(c.id.replace('comp_', ''));
                        if (num >= componentIdCounter) componentIdCounter = num + 1;
                    });

                    rerenderCanvas();
                    saveHistory();

                    closeImportImageModal();
                    showToast(`Imported ${components.length} components from image!`, 'success');
                } else {
                    throw new Error('Invalid response format');
                }

            } catch (err) {
                console.error('Error:', err);
                showToast('Error: ' + err.message, 'error');
            } finally {
                document.getElementById('importStatus').style.display = 'none';
                updateAnalyzeButton();
            }
        }

        // Initialize
        saveHistory();
        initCanvasResize();
        setCanvasSize(false);
    </script>

    <!-- Optional: Add html2canvas for PNG export -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
